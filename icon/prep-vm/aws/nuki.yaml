---

node:
  type: nukikata
  merge: true
  template: https://github.com/insight-icon/terraform-icon-aws-prep
#  checkout: master # change in tg.hcl
  existing_context: "{{ nuki }}"

# Write Deployment
write_:
  type: nukikata
  context_file: "{{ nuki.scripts_dir_ }}/write.yaml"
  existing_context: "{{ nuki }}"

# Apply
apply_confirm_:
  type: confirm
  message: Do you want deploy now?

create_run_file_:
  type: yaml
  path: "{{ apply.run_file_ }}"
  contents: "{{ apply }}"
  when: "{{ nuki.apply_confirm_ }}"
  filter: "{{ apply.settings_.deployment_id_label_order }}"

apply_:
  type: shell
  loop:
    - data
    - node
  chdir: "{{ nuki.item }}"
  command: terragrunt apply --terragrunt-source-update --auto-approve
  when: "{{ nuki.apply_confirm_ }}"
